{% extends "base.html" %}
{% block content %}

<h1 class="page-title">
    {{ "–ö–æ—Ä–∑–∏–Ω–∞" if lang == "ru" else "Cart" }}
</h1>

{% if cart_items %}

<div class="cart-list">
    {% for item in cart_items %}
    <div class="cart-row" id="row-{{ item.product.id }}">

        <img
            src="{{ url_for('static', filename=item.product.image) }}"
            class="cart-img"
            loading="lazy"
        >

        <div class="cart-info">
            <div class="cart-name">
                {{ item.product["name_" + lang] }}
            </div>

            <div class="cart-qty">
                <button onclick="updateQty({{ item.product.id }}, 'minus')">‚àí</button>
                <span id="qty-{{ item.product.id }}">{{ item.qty }}</span>
                <button onclick="updateQty({{ item.product.id }}, 'plus')">+</button>
            </div>

            <div class="cart-subtotal" id="subtotal-{{ item.product.id }}">
                {{ "%.2f"|format(item.subtotal) }} ‚Ç¨
            </div>
        </div>

    </div>
    {% endfor %}
</div>

<div class="cart-total">
    <strong>{{ "–ò—Ç–æ–≥–æ" if lang == "ru" else "Total" }}:</strong>
    <span id="cart-total">{{ "%.2f"|format(total) }} ‚Ç¨</span>
</div>

<!-- üî• –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
<div class="cart-actions">
    <a href="/catalog" class="popup-btn">
        ‚Üê {{ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏" if lang == "ru" else "Continue shopping" }}
    </a>

    {% if current_user.is_authenticated %}
        <a href="/order" class="popup-btn primary">
            {{ "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" if lang == "ru" sign up" }}
        </a>
    {% else %}
        <a href="/register" class="popup-btn primary">
            {{ "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∑–∞–∫–∞–∑–∞" if lang == "ru" else "to checkout" }}
        </a>
    {% endif %}
</div>

{% else %}

<p class="empty-cart">
    {{ "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞" if lang == "ru" else "Cart is empty" }}
</p>

{% endif %}

<script>
function updateQty(productId, action) {
    fetch(`/api/update_cart/${productId}/${action}`, {
        method: "POST",
        credentials: "include"
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;

        if (data.qty === 0) {
            const row = document.getElementById(`row-${productId}`);
            if (row) row.remove();
        } else {
            document.getElementById(`qty-${productId}`).textContent = data.qty;
            document.getElementById(`subtotal-${productId}`).textContent =
                data.subtotal.toFixed(2) + " ‚Ç¨";
        }

        document.getElementById("cart-total").textContent =
            data.total.toFixed(2) + " ‚Ç¨";

        document.getElementById("cart-count").textContent =
            data.cart_total_items;

        if (data.cart_total_items === 0) {
            location.reload();
        }
    });
}
</script>

{% endblock %}
