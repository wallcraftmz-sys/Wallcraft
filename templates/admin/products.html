{% extends "admin/admin_base.html" %}
{% block admin_content %}

<h1 class="page-title">{{ t("admin_products") }}</h1>

<div style="margin-bottom:20px; display:flex; gap:10px;">
  <a href="{{ url_for('admin_products', show='active') }}"
     class="admin-link {% if show == 'active' %}primary{% endif %}">{{ t("active") }}</a>

  <a href="{{ url_for('admin_products', show='inactive') }}"
     class="admin-link {% if show == 'inactive' %}primary{% endif %}">{{ t("inactive") }}</a>

  <a href="{{ url_for('admin_products', show='all') }}"
     class="admin-link {% if show == 'all' %}primary{% endif %}">{{ t("all") }}</a>
</div>

{% for cat_key, cat in grouped.items() %}
  <div class="admin-card" style="margin-bottom:18px;">
    <h2 style="margin-bottom:12px;">
      {% if cat.labels and cat.labels.get(lang) %}
        {{ cat.labels.get(lang) }}
      {% else %}
        {{ cat.labels.get('ru') if cat.labels else cat_key }}
      {% endif %}
    </h2>

    <div class="product-grid admin-products">

      {% if cat_key != 'other' %}
        <form method="post" enctype="multipart/form-data" class="product-card add-product-card">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="category" value="{{ cat_key }}">

          <div class="product-image add-image">
            ‚ûï
            <img class="preview" style="display:none;width:100%;border-radius:12px;margin-top:10px;">
          </div>

          <div class="product-info">
            <input name="name_ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ RU" required>
            <input name="name_lv" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ LV" required>
            <input name="price" type="number" step="0.01" placeholder="{{ t('price') }} ‚Ç¨" required>

            <input type="file" name="image" accept="image/*" required onchange="previewImage(event, this)">

            <button class="add-to-cart-btn" type="submit">{{ t("add_product") }}</button>
          </div>
        </form>
      {% endif %}

      {% for product in cat["items"] %}
        <div class="product-card {% if not product.is_active %}inactive{% endif %}">
          <div class="product-image">
            <img src="{{ url_for('static', filename=product.image or 'images/no-image.png') }}">
          </div>

          <div class="product-info">
            <h3 class="product-title">{{ product.name_ru }}</h3>
            <div class="product-price">{{ product.price }} ‚Ç¨</div>

            <div class="admin-product-actions">
              <a href="{{ url_for('edit_product', id=product.id) }}" class="admin-btn edit">‚úèÔ∏è</a>

              {% if product.is_active %}
                <form action="{{ url_for('delete_product', id=product.id) }}" method="post"
                      onsubmit="return confirm('{{ t('confirm_hide_product') }}');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <button type="submit" class="admin-btn delete">‚ùå</button>
                </form>
              {% else %}
                <form action="{{ url_for('restore_product', id=product.id) }}" method="post">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <button type="submit" class="admin-btn edit" title="{{ t('restore') }}">‚ôªÔ∏è</button>
                </form>

                <form action="{{ url_for('hard_delete_product', id=product.id) }}" method="post"
                      onsubmit="return confirm('{{ t('confirm_hard_delete_product') }}');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <button type="submit" class="danger-btn" title="{{ t('delete_forever') }}">üóë</button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}

    </div>
  </div>
{% endfor %}

<script>
function previewImage(event, input) {
  const form = input.closest("form");
  if (!form) return;
  const img = form.querySelector(".preview");
  if (!img) return;
  img.src = URL.createObjectURL(event.target.files[0]);
  img.style.display = "block";
}
</script>

{% endblock %}
