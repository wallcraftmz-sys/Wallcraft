{% extends "base.html" %}
{% block content %}
{% set lang = session.get('lang', 'ru') %}

<h1 style="text-align:center; font-size:28px; margin-bottom:25px;">
    {{ "Каталог товаров" if lang=="ru" else "Preču katalogs" }}
</h1>

<div class="product-grid">
    {% for p in products %}
    <div class="product-card">
        <img src="{{ url_for('static', filename=p.image) }}">
        <h3 style="font-size:20px;">{{ p["name_" + lang] }}</h3>
        <p style="font-size:16px;">{{ p["description_" + lang] }}</p>
        <p class="price" style="font-size:18px; font-weight:bold;">{{ "%.2f"|format(p.price) }} €</p>
        <button class="buy-btn" onclick="addToCart({{ p.id }})" 
                style="font-size:16px; padding:10px 15px; border-radius:8px;">
            {{ "В корзину" if lang=="ru" else "Grozā" }}
        </button>
    </div>
    {% endfor %}
</div>

<!-- Попап -->
<div id="popup" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; text-align:center;">
      <div id="popup-text" style="font-size:18px;"></div>
      <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
          <a href="/catalog?lang={{ lang }}" class="buy-btn" style="background:#2196F3; padding:8px 12px; border-radius:6px; color:#fff; text-decoration:none;">
              {{ "Продолжить покупки" if lang=="ru" else "Turpināt iepirkties" }}
          </a>
          <a href="/cart?lang={{ lang }}" class="buy-btn" style="background:#4CAF50; padding:8px 12px; border-radius:6px; color:#fff; text-decoration:none;">
              {{ "Перейти в корзину" if lang=="ru" else "Pāriet uz grozu" }}
          </a>
      </div>
      <button onclick="closePopup()" style="margin-top:12px; background:none; border:none; color:#777; cursor:pointer;">
          {{ "Закрыть" if lang=="ru" else "Aizvērt" }}
      </button>
  </div>
</div>

<script>
const lang = "{{ lang }}";

function addToCart(id) {
    fetch(`/api/add_to_cart/${id}`, { method:'POST' })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            document.getElementById('popup-text').innerHTML = `
                <b>${lang=='ru' ? data.product.name_ru : data.product.name_lv}</b><br>
                ${data.cart_total_items} ${lang=='ru' ? 'шт' : 'gab'}`;
            document.getElementById('popup').style.display='flex';
            const c = document.getElementById('cart-count');
            if(c) c.innerText = data.cart_total_items;
        } else {
            alert(lang=='ru'?'Ошибка при добавлении в корзину':'Kļūda, pievienojot grozam');
        }
    });
}

function closePopup() {
    document.getElementById('popup').style.display='none';
}
</script>
{% endblock %}
