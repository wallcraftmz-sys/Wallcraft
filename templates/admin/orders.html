{% extends "admin/admin_base.html" %}
{% block content %}

<h1>–ó–∞–∫–∞–∑—ã</h1>

<!-- –§–ò–õ–¨–¢–† -->
<div style="margin-bottom:20px; display:flex; gap:10px;">
    <a href="{{ url_for('admin_orders', show='active') }}"
       class="admin-link {% if show == 'active' %}primary{% endif %}">
        –ê–∫—Ç–∏–≤–Ω—ã–µ
    </a>

    <a href="{{ url_for('admin_orders', show='archive') }}"
       class="admin-link {% if show == 'archive' %}primary{% endif %}">
        –ê—Ä—Ö–∏–≤
    </a>
</div>

<!-- –ü–û–ò–°–ö -->
<form method="get"
      style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
    <input type="hidden" name="show" value="{{ show }}">

    <input
        type="text"
        name="q"
        placeholder="–ü–æ–∏—Å–∫: ID, –∏–º—è, –∫–æ–Ω—Ç–∞–∫—Ç"
        value="{{ request.args.get('q', '') }}"
        style="padding:6px 10px; min-width:260px;"
    >

    <button type="submit" class="admin-link">üîç –ù–∞–π—Ç–∏</button>

    {% if request.args.get('q') %}
        <a href="{{ url_for('admin_orders', show=show) }}"
           class="admin-link danger">
            ‚úñ –°–±—Ä–æ—Å
        </a>
    {% endif %}
</form>

<!-- –≠–ö–°–ü–û–†–¢ -->
<a href="{{ url_for('export_orders_csv', show=show, q=request.args.get('q','')) }}"
   class="admin-link"
   style="margin-bottom:15px; display:inline-block;">
    ‚¨á –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ (CSV)
</a>

{% if orders %}

<table class="admin-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
            <th>–°–æ—Å—Ç–∞–≤</th>
            <th>–°—É–º–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ò—Å—Ç–æ—Ä–∏—è</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>

    {% for order in orders %}
        <tr class="status-row status-{{ order.status }}">

            <td>
                <a href="{{ url_for('admin_order_view', order_id=order.id) }}">
                    #{{ order.id }}
                </a>
            </td>

            <td>
                {{ order.name }}<br>
                <small>{{ order.contact }}</small>
            </td>

            <td style="white-space: pre-line;">{{ order.items }}</td>

            <td><strong>{{ order.total }} ‚Ç¨</strong></td>

            <!-- –°–¢–ê–¢–£–° -->
            <td>
                <form method="post"
                      action="{{ url_for('update_order_status', order_id=order.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <select name="status" onchange="this.form.submit()">
                        {% for key, labels in ORDER_STATUSES.items() %}
                            {% if key == order.status
                                  or key in ALLOWED_STATUS_TRANSITIONS.get(order.status, []) %}
                                <option value="{{ key }}"
                                    {% if order.status == key %}selected{% endif %}>
                                    {{ labels[lang] }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </form>
            </td>

            <!-- –ò–°–¢–û–†–ò–Ø -->
            <td>
                {% for h in order.status_history %}
                    <div style="font-size:12px; opacity:0.7;">
                        {{ h.created_at.strftime("%d.%m.%Y %H:%M") }} ‚Äî
                        {{ ORDER_STATUSES[h.old_status][lang] if h.old_status else "‚Äî" }}
                        ‚Üí
                        {{ ORDER_STATUSES[h.new_status][lang] }}
                        ({{ h.changed_by }})
                    </div>
                {% else %}
                    <span style="opacity:0.5;">‚Äî</span>
                {% endfor %}
            </td>

            <td>{{ order.created_at.strftime("%d.%m.%Y %H:%M") }}</td>

            <!-- –î–ï–ô–°–¢–í–ò–Ø -->
            <td style="display:flex; gap:8px; align-items:center;">

                <!-- 27: –ü–ï–ß–ê–¢–¨ -->
                <a class="admin-link"
                   href="{{ url_for('admin_order_print', order_id=order.id) }}"
                   target="_blank"
                   title="–ü–µ—á–∞—Ç—å">
                    üñ®
                </a>

                {% if show == 'archive' %}

                    <!-- 24: RESTORE (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ completed) -->
                    {% if order.status != 'completed' %}
                    <form method="post"
                          action="{{ url_for('restore_order', order_id=order.id) }}"
                          onsubmit="return confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∞—Ä—Ö–∏–≤–∞?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="admin-btn edit" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚ôªÔ∏è</button>
                    </form>
                    {% endif %}

                    <!-- 25: HARD DELETE -->
                    <form method="post"
                          action="{{ url_for('hard_delete_order', order_id=order.id) }}"
                          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –ù–ê–í–°–ï–ì–î–ê? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="danger-btn" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞">üóë</button>
                    </form>

                {% else %}

                    <!-- –ê—Ä—Ö–∏–≤ (soft) -->
                    <form method="post"
                          action="{{ url_for('delete_order', order_id=order.id) }}"
                          onsubmit="return confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –≤ –∞—Ä—Ö–∏–≤?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button type="submit" class="danger-btn" title="–í –∞—Ä—Ö–∏–≤">üóë</button>
                    </form>

                {% endif %}

            </td>

        </tr>
    {% endfor %}

    </tbody>
</table>

<!-- –ü–ê–ì–ò–ù–ê–¶–ò–Ø -->
{% if pagination and pagination.pages > 1 %}
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('admin_orders', show=show, page=pagination.prev_num, q=request.args.get('q','')) }}">‚Üê</a>
    {% endif %}

    {% for p in range(1, pagination.pages + 1) %}
        {% if p == pagination.page %}
            <span class="current">{{ p }}</span>
        {% else %}
            <a href="{{ url_for('admin_orders', show=show, page=p, q=request.args.get('q','')) }}">{{ p }}</a>
        {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
        <a href="{{ url_for('admin_orders', show=show, page=pagination.next_num, q=request.args.get('q','')) }}">‚Üí</a>
    {% endif %}
</div>
{% endif %}

{% else %}
    <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
{% endif %}

{% endblock %}
