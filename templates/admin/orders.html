{% extends "admin/admin_base.html" %}
{% block admin_content %}

<h1>{{ t("admin_orders") }}</h1>

<div style="margin-bottom:20px; display:flex; gap:10px;">
  <a href="{{ url_for('admin_orders', show='active') }}"
     class="admin-link {% if show == 'active' %}primary{% endif %}">
    {{ t("active") }}
  </a>

  <a href="{{ url_for('admin_orders', show='archive') }}"
     class="admin-link {% if show == 'archive' %}primary{% endif %}">
    {{ t("archive") }}
  </a>
</div>

<form method="get" style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
  <input type="hidden" name="show" value="{{ show }}">

  <input
    type="text"
    name="q"
    placeholder="{{ t('search_placeholder') }}"
    value="{{ request.args.get('q', '') }}"
    style="padding:6px 10px; min-width:260px;"
  >

  <button type="submit" class="admin-link">ğŸ” {{ t("search") }}</button>

  {% if request.args.get('q') %}
    <a href="{{ url_for('admin_orders', show=show) }}" class="admin-link danger">
      âœ– {{ t("reset") }}
    </a>
  {% endif %}
</form>

<a href="{{ url_for('export_orders_csv', show=show, q=request.args.get('q','')) }}"
   class="admin-link"
   style="margin-bottom:15px; display:inline-block;">
  â¬‡ {{ t("export_csv") }}
</a>

{% if orders %}

<table class="admin-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>{{ t("buyer") }}</th>

      <!-- âœ… ĞĞĞ’ĞĞ• -->
      <th>{{ t("th_address") }}</th>
      <th>{{ t("th_time") }}</th>
      <th>{{ t("th_courier") }}</th>

      <th>{{ t("items") }}</th>
      <th>{{ t("sum") }}</th>
      <th>{{ t("status") }}</th>
      <th>{{ t("history") }}</th>
      <th>{{ t("date") }}</th>
      <th>{{ t("actions") }}</th>
    </tr>
  </thead>

  <tbody>
  {% for order in orders %}
    <tr class="status-row status-{{ order.status }}">

      <td>
        <a href="{{ url_for('admin_order_view', order_id=order.id) }}">#{{ order.id }}</a>
      </td>

      <td>
        {{ order.name }}<br>
        <small>{{ order.contact }}</small>
      </td>

      <!-- âœ… ĞĞĞ’ĞĞ•: ĞĞ´Ñ€ĞµÑ -->
      <td style="white-space: pre-line;">
        {{ order.address if order.address else "â€”" }}
      </td>

      <!-- âœ… ĞĞĞ’ĞĞ•: Ğ’Ñ€ĞµĞ¼Ñ -->
      <td>
        {{ order.delivery_time if order.delivery_time else "â€”" }}
      </td>

      <!-- âœ… ĞĞĞ’ĞĞ•: ĞšÑƒÑ€ÑŒĞµÑ€ -->
      <td>
        {{ order.courier if order.courier else "â€”" }}
      </td>

      <td style="white-space: pre-line;">{{ order.items }}</td>

      <td><strong>{{ order.total }} â‚¬</strong></td>

      <td>
        <form method="post" action="{{ url_for('update_order_status', order_id=order.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <select name="status" onchange="this.form.submit()">
            {% for key, labels in ORDER_STATUSES.items() %}
              {% if key == order.status or key in ALLOWED_STATUS_TRANSITIONS.get(order.status, []) %}
                <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>
                  {{ labels[lang] }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </form>
      </td>

      <td>
        {% for h in order.status_history %}
          <div style="font-size:12px; opacity:0.7;">
            {{ h.created_at.strftime("%d.%m.%Y %H:%M") }} â€”
            {{ ORDER_STATUSES[h.old_status][lang] if h.old_status else "â€”" }}
            â†’
            {{ ORDER_STATUSES[h.new_status][lang] }}
            ({{ h.changed_by }})
          </div>
        {% else %}
          <span style="opacity:0.5;">â€”</span>
        {% endfor %}
      </td>

      <td>{{ order.created_at.strftime("%d.%m.%Y %H:%M") }}</td>

      <td style="display:flex; gap:8px; align-items:center;">
        <a class="admin-link"
           href="{{ url_for('admin_order_print', order_id=order.id) }}"
           target="_blank"
           title="{{ t('print') }}">
          ğŸ–¨
        </a>

        {% if show == 'archive' %}

          {% if order.status != 'completed' %}
            <form method="post" action="{{ url_for('restore_order', order_id=order.id) }}"
                  onsubmit="return confirm('{{ t('confirm_restore_order') }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <button type="submit" class="admin-btn edit" title="{{ t('restore') }}">â™»ï¸</button>
            </form>
          {% endif %}

          <form method="post" action="{{ url_for('hard_delete_order', order_id=order.id) }}"
                onsubmit="return confirm('{{ t('confirm_hard_delete_order') }}');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="danger-btn" title="{{ t('delete_forever') }}">ğŸ—‘</button>
          </form>

        {% else %}

          <form method="post" action="{{ url_for('delete_order', order_id=order.id) }}"
                onsubmit="return confirm('{{ t('confirm_archive_order') }}');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="danger-btn" title="{{ t('to_archive') }}">ğŸ—‘</button>
          </form>

        {% endif %}
      </td>

    </tr>
  {% endfor %}
  </tbody>
</table>

{% else %}
  <p>{{ t("no_orders") }}</p>
{% endif %}

{% endblock %}
