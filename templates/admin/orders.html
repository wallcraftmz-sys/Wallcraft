{% extends "admin/admin_base.html" %}
{% block content %}

<h1>üßæ –ó–∞–∫–∞–∑—ã</h1>

<div style="margin-bottom:20px; display:flex; gap:10px;">
    <a href="{{ url_for('admin_orders', show='active') }}"
       class="admin-link {% if show == 'active' %}primary{% endif %}">
        –ê–∫—Ç–∏–≤–Ω—ã–µ
    </a>

    <a href="{{ url_for('admin_orders', show='archive') }}"
       class="admin-link {% if show == 'archive' %}primary{% endif %}">
        –ê—Ä—Ö–∏–≤
    </a>
</div>

{% if orders %}

<table class="admin-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
            <th>–°–æ—Å—Ç–∞–≤</th>
            <th>–°—É–º–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ò—Å—Ç–æ—Ä–∏—è</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>

    {% for order in orders %}
        <tr class="status-row status-{{ order.status }}">

            <td>
                <a href="{{ url_for('admin_order_view', order_id=order.id) }}">
                    #{{ order.id }}
                </a>
            </td>

            <td>
                {{ order.name }}<br>
                <small>{{ order.contact }}</small>
            </td>

            <td style="white-space: pre-line">{{ order.items }}</td>

            <td><strong>{{ order.total }} ‚Ç¨</strong></td>

            <!-- –°–¢–ê–¢–£–° -->
            <td>
                <form method="post"
                      action="{{ url_for('update_order_status', order_id=order.id) }}">
                    <select name="status" onchange="this.form.submit()">
    {% for key, labels in ORDER_STATUSES.items() %}
        {% if key == order.status or key in ALLOWED_STATUS_TRANSITIONS[order.status] %}
            <option value="{{ key }}"
                {% if order.status == key %}selected{% endif %}>
                {{ labels[lang] }}
            </option>
        {% endif %}
    {% endfor %}                   
</select>
                </form>
            </td>

            <!-- –ò–°–¢–û–†–ò–Ø –°–¢–ê–¢–£–°–û–í -->
            <td>
                {% for h in order.status_history %}
                    <div style="font-size:12px; opacity:0.7">
                        {{ h.created_at.strftime("%d.%m.%Y %H:%M") }} ‚Äî
                        {{ ORDER_STATUSES[h.old_status][lang] }}
                        ‚Üí
                        {{ ORDER_STATUSES[h.new_status][lang] }}
                        ({{ h.changed_by }})
                    </div>
                {% else %}
                    <span style="opacity:0.5">‚Äî</span>
                {% endfor %}
            </td>

            <td>{{ order.created_at.strftime("%d.%m.%Y %H:%M") }}</td>

            <!-- –£–î–ê–õ–ï–ù–ò–ï -->
            <td>
                <form method="post"
                      action="{{ url_for('delete_order', order_id=order.id) }}"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?');">
                    <button type="submit" class="danger-btn">üóë</button>
                </form>
            </td>

        </tr>
    {% endfor %}

    </tbody>
</table>

{% else %}
    <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
{% endif %}

{% endblock %}
