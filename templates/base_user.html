<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <title>Wallcraft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=9999">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}?v=9999">

  <!-- âœ… Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ cache busting -->
  <script defer src="{{ url_for('static', filename='js/main.js') }}?v=9999"></script>

  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <meta property="og:title" content="Wallcraft">
  <meta property="og:description" content="ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð¾Ð².">
  <meta property="og:image" content="{{ url_for('static', filename='images/IMG_0857.jpeg', _external=True) }}">
  <meta property="og:url" content="{{ request.url }}">
  <meta name="twitter:card" content="summary_large_image">
</head>

<body class="{{ 'is-admin' if request.path.startswith('/admin') else '' }}">

<header class="top-header">
  <button class="menu-btn" type="button" onclick="wcMenuOpen()" aria-label="Menu">â˜°</button>

  <div class="logo-center">
    <a href="{{ url_for('index', lang=lang) }}" class="logo-link" aria-label="Wallcraft">
      <img class="logo-img" src="{{ url_for('static', filename='images/IMG_0857.jpeg') }}" alt="Wallcraft">
      <span class="logo-text">Wallcraft</span>
    </a>
  </div>

  <div class="header-auth">
    {% if current_user.is_authenticated %}
      <a class="header-link" href="{{ url_for('profile', lang=lang) }}">{{ t("profile") }}</a>
      <span class="header-sep">|</span>
      <a class="header-link" href="{{ url_for('logout', lang=lang) }}">{{ t("logout") }}</a>
    {% else %}
      <a class="header-link" href="{{ url_for('login', lang=lang) }}">{{ t("login") }}</a>
      <span class="header-sep">|</span>
      <a class="header-link" href="{{ url_for('register', lang=lang) }}">{{ t("register") }}</a>
    {% endif %}
  </div>
</header>

<!-- OVERLAY -->
<div id="wcMenuOverlay" class="wc-overlay" onclick="wcMenuClose()"></div>

<!-- DRAWER -->
<aside id="wcMenu" class="wc-drawer wc-min" aria-hidden="true">

  <!-- TOP -->
  <div class="wc-top">
    <div class="wc-drawer-head">
      <div class="wc-brand">
        <img class="wc-brand-logo" src="{{ url_for('static', filename='images/IMG_0857.jpeg') }}" alt="Wallcraft">
        <div class="wc-brand-title">Wallcraft</div>
      </div>
      <button class="wc-close" type="button" onclick="wcMenuClose()" aria-label="Close">âœ•</button>
    </div>

    <!-- LANG -->
    <div class="wc-lang">
  <a href="{{ url_for(request.endpoint, **(request.view_args or {}), lang='lv', **request.args.to_dict(flat=True)) }}"
     class="{{ 'active' if lang=='lv' }}">LV</a>

  <a href="{{ url_for(request.endpoint, **(request.view_args or {}), lang='ru', **request.args.to_dict(flat=True)) }}"
     class="{{ 'active' if lang=='ru' }}">RU</a>

  <a href="{{ url_for(request.endpoint, **(request.view_args or {}), lang='en', **request.args.to_dict(flat=True)) }}"
     class="{{ 'active' if lang=='en' }}">EN</a>
</div>

    <div class="wc-line"></div>
  </div>

  <!-- MIDDLE -->
  <div class="wc-mid" role="navigation" aria-label="Menu">

    <!-- âœ… Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº: ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ â†’ ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ â†’ ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° -->
    {% if current_user.is_authenticated %}
      <a class="wc-link" href="{{ url_for('profile', lang=lang) }}" onclick="wcMenuClose()">
        <span class="wc-txt">{{ t("profile") }}</span>
      </a>
    {% endif %}

    <a class="wc-link" href="{{ url_for('catalog', lang=lang) }}" onclick="wcMenuClose()">
      <span class="wc-txt">{{ t("catalog") }}</span>
    </a>

    <a class="wc-link" href="{{ url_for('cart', lang=lang) }}" onclick="wcMenuClose()">
      <span class="wc-txt">{{ t("cart") }}</span>
      <span class="wc-pill" id="menu-cart-pill">{{ cart_total_items or 0 }}</span>
    </a>

  </div>

  <!-- BOTTOM -->
  <div class="wc-bot">
    {% if current_user.is_authenticated and current_user.role == 'admin' %}
      <div class="wc-line"></div>
      <div class="wc-subtitle">{{ t("admin") }}</div>

      <a class="wc-link" href="{{ url_for('admin_products', lang=lang) }}" onclick="wcMenuClose()">
        <span class="wc-txt">{{ t("products") }}</span>
      </a>

      <a class="wc-link" href="{{ url_for('admin_orders', lang=lang) }}" onclick="wcMenuClose()">
        <span class="wc-txt">{{ t("orders") }}</span>
      </a>
    {% endif %}
  </div>

</aside>

<main class="container">
  {% if breadcrumbs and breadcrumbs|length > 1 %}
    <nav class="breadcrumbs" aria-label="breadcrumb">
      {% for c in breadcrumbs %}
        {% if loop.last %}
          <span class="bc-current">{{ c.title }}</span>
        {% else %}
          <a class="bc-link" href="{{ c.url }}">{{ c.title }}</a>
          <span class="bc-sep">/</span>
        {% endif %}
      {% endfor %}
    </nav>
  {% endif %}

  {% block content %}{% endblock %}
</main>

{% if not request.path.startswith('/admin') %}
<a href="{{ url_for('cart', lang=lang) }}" class="cart-fab" aria-label="ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð°">
  <span class="cart-fab-ico">ðŸ›’</span>
  <span id="cart-count" class="cart-badge">0</span>
</a>

<div id="cart-action-popup" class="cart-action-popup" aria-hidden="true">
  <div class="cart-action-inner">
    <span class="cart-action-text">{{ t("added") }}</span>

    <div class="cart-action-buttons">
      <button type="button" onclick="closeCartAction()">{{ t("continue") }}</button>
      <a href="{{ url_for('cart', lang=lang) }}">{{ t("go_to_cart") }}</a>
    </div>
  </div>
</div>
{% endif %}

<script>
function wcMenuOpen(){
  const m = document.getElementById("wcMenu");
  const o = document.getElementById("wcMenuOverlay");
  if(!m || !o) return;
  m.classList.add("open");
  o.classList.add("show");
  m.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}
function wcMenuClose(){
  const m = document.getElementById("wcMenu");
  const o = document.getElementById("wcMenuOverlay");
  if(!m || !o) return;
  m.classList.remove("open");
  o.classList.remove("show");
  m.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
}

document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") wcMenuClose();
});

async function refreshCartCount() {
  try {
    const res = await fetch("/api/cart_count", { credentials: "same-origin" });
    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) return;

    const data = await res.json();
    const n = (data && typeof data.cart_total_items === "number") ? data.cart_total_items : 0;

    const badge = document.getElementById("cart-count");
    if (badge) {
      badge.textContent = n;
      badge.style.display = n > 0 ? "inline-flex" : "none";
    }

    const menuPill = document.getElementById("menu-cart-pill");
    if (menuPill) menuPill.textContent = n;

  } catch (e) {}
}
document.addEventListener("DOMContentLoaded", refreshCartCount);

function openCartAction(){
  const p = document.getElementById("cart-action-popup");
  if(!p) return;
  p.classList.add("show");
  p.setAttribute("aria-hidden","false");
  clearTimeout(window.__cartPopupTimer);
  window.__cartPopupTimer = setTimeout(closeCartAction, 3000);
}

function closeCartAction(){
  const p = document.getElementById("cart-action-popup");
  if(!p) return;
  p.classList.remove("show");
  p.setAttribute("aria-hidden","true");
}
</script>

</body>
</html>
