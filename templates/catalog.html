{% extends "base.html" %}
{% block content %}

<h1 style="text-align:center; margin-bottom:30px;">
    {{ "Каталог товаров" if lang=="ru" else "Preču katalogs" }}
</h1>

<div class="product-grid" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center;">

    {% for product in products %}
    <div class="product-card" style="background:#fff; padding:15px; border-radius:8px; width:240px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.1);">

        <!-- Фото -->
        {% if product.image and product.image.startswith('http') %}
            <img src="{{ product.image }}" alt="{{ product.get('name_' + lang, product.get('name_ru')) }}" style="width:100%; height:180px; object-fit:cover; border-radius:6px;">
        {% else %}
            <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.get('name_' + lang, product.get('name_ru')) }}" style="width:100%; height:180px; object-fit:cover; border-radius:6px;">
        {% endif %}

        <!-- Название -->
        <h3 style="margin:12px 0 6px 0; font-size:16px; min-height:48px;">
            {{ product.get("name_" + lang, product.get("name_ru")) }}
        </h3>

        <!-- Короткое описание -->
        <p style="color:#555; font-size:14px; min-height:40px;">
            {{ product.get("description_" + lang, product.get("description_ru"))[:80] }}{% if product.get("description_" + lang, product.get("description_ru"))|length > 80 %}…{% endif %}
        </p>

        <!-- Цена -->
        <p class="price" style="font-weight:bold; margin:6px 0;">{{ "%.2f"|format(product.price) }} €</p>

        <!-- Кнопка В корзину -->
        <button class="buy-btn" style="background:#4CAF50; color:#fff; padding:8px 14px; border:none; border-radius:6px; cursor:pointer;"
                onclick="addToCart({{ product.id }})">
            {{ "В корзину" if lang=="ru" else "Ielikt grozā" }}
        </button>

    </div>
    {% endfor %}

</div>

<!-- Попап после добавления в корзину -->
<div id="popup" class="popup" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999;">
    <div class="popup-content" style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; text-align:center;">
        <div id="popup-text" style="margin-bottom:15px;"></div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <a href="/catalog" class="buy-btn" style="background:#2196F3; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none;">
                {{ "Продолжить покупки" if lang=="ru" else "Turpināt iepirkties" }}
            </a>
            <a href="/cart" class="buy-btn" style="background:#4CAF50; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none;">
                {{ "Перейти в корзину" if lang=="ru" else "Pāriet uz grozu" }}
            </a>
        </div>
        <div style="margin-top:10px;">
            <button onclick="closePopup()" style="background:none; border:none; color:#777; cursor:pointer;">
                {{ "Закрыть" if lang=="ru" else "Aizvērt" }}
            </button>
        </div>
    </div>
</div>

<script>
function addToCart(productId){
    fetch(`/api/add_to_cart/${productId}`, { method:'POST' })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            const p = data.product;
            document.getElementById('popup-text').innerHTML =
                `<div style="display:flex; gap:12px; align-items:center;">
                    <img src="${p.image}" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">
                    <div style="text-align:left;">
                        <b style="font-size:16px;">${p.name_ru}</b><br>
                        ${p.qty} × ${p.price} €
                    </div>
                 </div>`;
            document.getElementById('popup').style.display='flex';

            // обновим счетчик корзины в шапке
            fetch('/api/cart_count')
                .then(r => r.json())
                .then(d => {
                    const el = document.getElementById('cart-count');
                    if(el) el.innerText = d.count;
                })
                .catch(()=>{});
        }
    })
    .catch(err => {
        console.error('addToCart error', err);
        alert('{{ "Ошибка при добавлении в корзину" if lang=="ru" else "Kļūda, pievienojot grozam" }}');
    });
}

function closePopup(){
    document.getElementById('popup').style.display='none';
}
</script>

{% endblock %}
